name: Contract Propagation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - "openapi.yaml"
  push:
    branches: [main]
    paths:
      - "openapi.yaml"
  workflow_dispatch:

jobs:
  propagate:
    runs-on: ubuntu-latest
    env:
      API_CORE_DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
      API_CORE_DATABASE_URL: sqlite+aiosqlite:///./data/api_core.db
      API_CORE_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PROPAGATE_AUTO_MERGE: "false"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Verify dependency health
        run: python -m pip check

      - name: Runtime import smoke test
        run: python -c "import src.config, src.database"

      - name: Prepare data directory
        run: mkdir -p data

      - name: Seed baseline contract from event base
        run: |
          python -c "
          import asyncio, hashlib, json, os, subprocess, sys
          sys.path.insert(0, '.')
          os.environ.setdefault('API_CORE_DATABASE_URL', 'sqlite+aiosqlite:///./data/api_core.db')

          def _base_openapi_content():
              event_name = os.getenv('GITHUB_EVENT_NAME', '')
              event_path = os.getenv('GITHUB_EVENT_PATH', '')
              base_spec_ref = None

              try:
                  if event_path and os.path.exists(event_path):
                      with open(event_path) as f:
                          event = json.load(f)
                      if event_name == 'pull_request':
                          base_sha = event.get('pull_request', {}).get('base', {}).get('sha')
                          if base_sha:
                              base_spec_ref = f'{base_sha}:openapi.yaml'
                      elif event_name == 'push':
                          before_sha = event.get('before')
                          if before_sha and before_sha != '0000000000000000000000000000000000000000':
                              base_spec_ref = f'{before_sha}:openapi.yaml'
              except Exception as e:
                  print(f'Failed to parse event payload for baseline selection: {e}')

              candidates = [base_spec_ref, 'origin/main:openapi.yaml']
              for ref in candidates:
                  if not ref:
                      continue
                  try:
                      return subprocess.check_output(['git', 'show', ref], text=True)
                  except subprocess.CalledProcessError:
                      continue

              print('No base openapi.yaml found, seeding empty baseline')
              return json.dumps({'openapi': '3.1.0', 'info': {}, 'paths': {}})

          async def seed():
              base_content = _base_openapi_content()

              from src.database import async_session, init_db
              from src.entities.contract_snapshot import ContractSnapshot
              await init_db()

              base_hash = hashlib.sha256(base_content.encode()).hexdigest()[:16]
              async with async_session() as db:
                  from sqlalchemy import select
                  existing = await db.execute(
                      select(ContractSnapshot).limit(1)
                  )
                  if existing.scalar_one_or_none() is not None:
                      print('Baseline already exists, skipping seed')
                      return
                  snapshot = ContractSnapshot(
                      version_hash=base_hash,
                      content=base_content,
                      git_sha=os.getenv('GITHUB_SHA', ''),
                  )
                  db.add(snapshot)
                  await db.commit()
                  print(f'Seeded baseline contract: {base_hash}')

          asyncio.run(seed())
          "

      - name: Run database migrations
        run: alembic upgrade head

      - name: Detect and propagate contract changes
        run: python -m propagate --ci 2>&1 | tee data/propagate.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: propagation-logs
          path: |
            data/propagate.log
            data/api_core.db
          retention-days: 7
